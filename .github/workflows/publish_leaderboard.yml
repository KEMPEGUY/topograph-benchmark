name: Publish Leaderboard (on merge)

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  publish:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Reconstruct hidden labels
        env:
          LABELS_ALL_NPY_B64: ${{ secrets.LABELS_ALL_NPY_B64 }}
        run: |
          python - <<'EOF'
          import os, base64
          from pathlib import Path

          b64 = os.environ.get("LABELS_ALL_NPY_B64", "")
          if not b64:
              raise SystemExit("Missing secret LABELS_ALL_NPY_B64")

          out = Path("data/private")
          out.mkdir(parents=True, exist_ok=True)
          (out / "labels_all.npy").write_bytes(base64.b64decode(b64.encode("utf-8")))
          print("[OK] wrote data/private/labels_all.npy")
          EOF

      - name: Find merged submission file (base->merge diff)
        id: find
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          MERGE="${{ github.event.pull_request.merge_commit_sha }}"

          # Fallback: merge_commit_sha can be empty in some cases
          if [ -z "$MERGE" ]; then
            MERGE="${{ github.sha }}"
          fi

          echo "Base:  $BASE"
          echo "Merge: $MERGE"

          git diff --name-only "$BASE" "$MERGE" | tee changed_files.txt

          FILE=$(grep -E '^submissions/inbox/.+/predictions\.csv$' changed_files.txt | head -n 1)
          if [ -z "$FILE" ]; then
            echo "No predictions.csv found in this merged PR. Exiting cleanly."
            echo "file=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found submission: $FILE"
          echo "file=$FILE" >> $GITHUB_OUTPUT

          # Parse team + run from path: submissions/inbox/<team>/<run>/predictions.csv
          TEAM=$(echo "$FILE" | cut -d'/' -f3)
          RUN=$(echo "$FILE"  | cut -d'/' -f4)

          echo "team=$TEAM" >> $GITHUB_OUTPUT
          echo "run=$RUN" >> $GITHUB_OUTPUT

          echo "Parsed team: $TEAM"
          echo "Parsed run:  $RUN"

      - name: Validate submission (again on merge)
        if: steps.find.outputs.file != ''
        run: |
          python -m competition.validate_submission --submission "${{ steps.find.outputs.file }}"

      - name: Score merged submission
        if: steps.find.outputs.file != ''
        id: score
        run: |
          python -m competition.evaluate --submission "${{ steps.find.outputs.file }}" | tee score.txt
          SCORE=$(grep -E '^macro_f1:' score.txt | tail -n 1 | awk '{print $2}')
          if [ -z "$SCORE" ]; then
            echo "Could not parse macro_f1 from output"
            exit 1
          fi
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Parsed score: $SCORE"

      - name: Update leaderboard CSV (append + keep header once)
        if: steps.find.outputs.file != ''
        run: |
          mkdir -p leaderboard
          CSV="leaderboard/leaderboard.csv"

          # Correct header (5 columns)
          if [ ! -f "$CSV" ]; then
            echo "timestamp_utc,team,model,score,notes" > "$CSV"
          fi

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TEAM="${{ steps.find.outputs.team }}"
          MODEL="${{ steps.find.outputs.run }}"
          SCORE="${{ steps.score.outputs.score }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Correct row order (5 columns)
          echo "$TIMESTAMP,$TEAM,$MODEL,$SCORE,PR-$PR_NUMBER" >> "$CSV"

          echo "[OK] appended to $CSV"
          tail -n 5 "$CSV" || true

      - name: Render leaderboard artifacts
        if: steps.find.outputs.file != ''
        run: |
          python -m competition.render_leaderboard

      - name: Commit and push leaderboard updates
        if: steps.find.outputs.file != ''
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add leaderboard/leaderboard.csv leaderboard/leaderboard.md docs/ || true

          if git diff --cached --quiet; then
            echo "No leaderboard changes to commit."
            exit 0
          fi

          git commit -m "Update leaderboard (PR #${{ github.event.pull_request.number }})"
          git push
