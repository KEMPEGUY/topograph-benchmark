name: Score Submission (PR)

on:
  pull_request:
    paths:
      - "submissions/inbox/**/predictions.csv"

permissions:
  contents: read
  pull-requests: write

jobs:
  score:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Reconstruct hidden labels
        env:
          LABELS_ALL_NPY_B64: ${{ secrets.LABELS_ALL_NPY_B64 }}
        run: |
          python - <<'EOF'
          import os, base64
          from pathlib import Path

          b64 = os.environ.get("LABELS_ALL_NPY_B64", "")
          if not b64:
              raise SystemExit("Missing secret LABELS_ALL_NPY_B64")

          out = Path("data/private")
          out.mkdir(parents=True, exist_ok=True)
          (out / "labels_all.npy").write_bytes(base64.b64decode(b64.encode("utf-8")))
          print("[OK] wrote data/private/labels_all.npy")
          EOF

      - name: Find submission file in PR diff (base SHA -> head SHA)
        id: find
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          echo "Base: $BASE"
          echo "Head: $HEAD"

          git diff --name-only "$BASE" "$HEAD" | tee changed_files.txt

          FILE=$(cat changed_files.txt | grep -E '^submissions/inbox/.+/predictions\.csv$' | head -n 1)
          if [ -z "$FILE" ]; then
            echo "No predictions.csv found in PR diff."
            exit 1
          fi

          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "[INFO] submission file: $FILE"

      - name: Validate submission
        run: |
          python -m competition.validate_submission --submission "${{ steps.find.outputs.file }}"

      - name: Score submission
        id: score
        run: |
          python -m competition.evaluate --submission "${{ steps.find.outputs.file }}" | tee score.txt
          SCORE_LINE=$(grep -E '^macro_f1:' score.txt | tail -n 1)
          if [ -z "$SCORE_LINE" ]; then
            echo "Could not find macro_f1 line in output"
            exit 1
          fi
          echo "score_line=$SCORE_LINE" >> $GITHUB_OUTPUT

      - name: Comment score on PR
        uses: actions/github-script@v7
        with:
          script: |
            const scoreLine = `${{ steps.score.outputs.score_line }}`;
            const body = `âœ… **Submission scored**\n\n\`\`\`\n${scoreLine}\n\`\`\`\n\n(Leaderboard updates after merge.)`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

